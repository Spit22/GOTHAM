# Dockerfile Gotham Installation SERVER
FROM debian:jessie

# OS UPDATE
RUN apt-get -y update && apt-get -y dist-upgrade && apt-get -y autoremove && apt-get clean

#INSTALL DEPENDENCIES
RUN apt-get install -y curl git-all rsyslog apt-utils vim python3 python3-pip mariadb-server && \
    wget http://archive.ubuntu.com/ubuntu/pool/universe/m/mariadb-connector-c/libmariadb-dev_3.0.3-1build1_amd64.deb && \
    dpkg -i libmariadb-dev_3.0.3-1build1_amd64.deb  

ARG MARIADB_ROOT_PASSWORD: 'root'

RUN echo "=== Preparing the gotham system... ==="

#RUN $USERADD -o -u 0 -g 0 -N -d /root/ -M gotham > /dev/null 2>&1
RUN useradd -o -u 0 -g 0 -N -d /root/ -M gotham > /dev/null 2>&1
RUN echo "[+] User gotham created"

RUN echo -e "#GOTHAM global variables\nexport GOTHAM_HOME=/opt/GOTHAM/" > /etc/profile.d/gotham.sh
RUN chmod +x /etc/profile.d/gotham.sh && \
    echo "[+] Gotham profile generated under /etc/profile.d/gotham.sh"

RUN mkdir -p /data/template &&  \
    mkdir -p /data/rsyslog/datacenter-configuration && \
    mkdir -p /data/rsyslog/servers-configuration && \
    mkdir -p /data/honeypot-log && \
    mkdir -p /data/link-log && \ 
    mkdir -p /data/rsyslog/rulebase && \
    mkdir -p /etc/rsyslog.d && \
    echo "[+] All paths created"

RUN echo "=== Installing dependancies... ==="

RUN apt update > /dev/null 2>&1 && \
    echo "[+] APT updated"

#RUN apt install -y python3 python3-pip mariadb-server > /dev/null 2>&1 && \
#    echo "[+] Some packages correctly installed"

#RUN apt install -y libmariadb-dev > /dev/null 2>&1 && \
#    echo "[+] Some libraries correctly installed"

### INSTALL RSYSLOG ###
RUN echo "=== Configuring Rsyslog... ==="

# Pre-configure rsyslog
RUN touch /etc/rsyslog.d/00-syslog_server.conf && \
    echo "$template RawFormat,"%msg%\n" \
        module(load="imtcp") \
        input(type="imtcp" port="1514") && \
    > /etc/rsyslog.d/00-syslog_server.conf

# Restart rsyslog
# systemctl restart rsyslog > /dev/null 2>&1
RUN echo "[+] Rsyslog configured under /etc/rsyslog.d/"


### INSTALL GOTHAM ###
RUN echo "=== Installing GOTHAM... ==="

# Clone repository on this directory
RUN git clone https://github.com/Spit22/GOTHAM /opt/GOTHAM/ > /dev/null 2>&1 && \
    chown -R gotham:root /opt/GOTHAM/ && \
    echo "[+] GOTHAM cloned under /opt/GOTHAM/"

# Going on the repository folder
RUN cd /opt/GOTHAM/

# Choose the git branch
RUN git checkout remotes/origin/dev_V1 > /dev/null 2>&1 && \
    echo "[+] Switched to remotes/origin/dev_V1"

# Install all python libs
RUN pip3 install -r /opt/GOTHAM/Orchestrator/Sources/requirements.txt > /dev/null 2>&1 && \
    echo "[+] Pip dependancies installed"

# Create the log folder
RUN ["/bin/bash"] ["mkdir -p /opt/GOTHAM/Orchestrator/Logs"]

# Configure database
RUN ["/bin/bash"] ["mysql -u root -e "CREATE DATABASE GOTHAM;" > /dev/null 2>&1"] && \
    ["/bin/bash"] ["mysql -u root GOTHAM < /opt/GOTHAM/Orchestrator/Internal_Database/gotham.sql > /dev/null 2>&1"] && \
    echo "[+] MySQL db successfully imported"

CMD ["/bin/bash"]
